<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>StudyBuddy AI - Ultimate Hub (Super ChatGPT + StudyBuddy)</title>
<style>
:root{
  --bg:#070b12;--card:#0d1424;--card2:#0b1020;--txt:#e9f1ff;--mut:#9fb2d9;
  --pri:#7c5cff;--pri2:#00e5ff;--good:#1cff8b;--bad:#ff3b6a;--warn:#ffd24d;
  --b:rgba(255,255,255,.08);--b2:rgba(255,255,255,.14);
  --shadow:0 20px 60px rgba(0,0,0,.45);
  --r:18px;
  --mono: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono","Courier New", monospace;
  --ui: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
}
*{box-sizing:border-box}
html,body{height:100%}
body{
  margin:0;font-family:var(--ui);color:var(--txt);
  background:
    radial-gradient(900px 600px at 20% 10%, rgba(124,92,255,.25), transparent 55%),
    radial-gradient(900px 600px at 85% 15%, rgba(0,229,255,.16), transparent 55%),
    radial-gradient(900px 600px at 60% 90%, rgba(28,255,139,.10), transparent 55%),
    linear-gradient(180deg, #05070d 0%, #070b12 100%);
  overflow-x:hidden;
}
a{color:inherit}
button,input,select,textarea{font:inherit}
.wrap{max-width:1250px;margin:0 auto;padding:18px}
.topbar{
  display:flex;gap:14px;align-items:center;justify-content:space-between;
  padding:14px 16px;border:1px solid var(--b);background:rgba(13,20,36,.55);
  backdrop-filter: blur(12px);
  border-radius:var(--r);box-shadow:var(--shadow);
}
.brand{
  display:flex;align-items:center;gap:12px;min-width:260px;
}
.logo{
  width:44px;height:44px;border-radius:14px;
  background: linear-gradient(135deg, var(--pri), var(--pri2));
  box-shadow:0 10px 30px rgba(124,92,255,.25);
  display:grid;place-items:center;
  border:1px solid rgba(255,255,255,.15);
}
.logo svg{filter:drop-shadow(0 6px 10px rgba(0,0,0,.3))}
.brand h1{margin:0;font-size:16px;line-height:1.1}
.brand .sub{margin:0;color:var(--mut);font-size:12px}
.nav{
  display:flex;gap:8px;flex-wrap:wrap;justify-content:flex-end;
}
.nav button{
  border:1px solid var(--b);
  background:rgba(255,255,255,.04);
  color:var(--txt);
  padding:10px 12px;border-radius:14px;
  cursor:pointer;transition:.15s;
}
.nav button:hover{transform:translateY(-1px);border-color:var(--b2)}
.nav button.active{
  background:linear-gradient(135deg, rgba(124,92,255,.25), rgba(0,229,255,.14));
  border-color:rgba(124,92,255,.35);
}
.grid{
  display:grid;grid-template-columns: 1.25fr .85fr;
  gap:14px;margin-top:14px;
}
@media (max-width:980px){.grid{grid-template-columns:1fr}}
.card{
  border:1px solid var(--b);
  background:rgba(13,20,36,.55);
  backdrop-filter: blur(12px);
  border-radius:var(--r);
  box-shadow:var(--shadow);
}
.card .hd{
  padding:14px 16px;border-bottom:1px solid var(--b);
  display:flex;align-items:center;justify-content:space-between;gap:10px;
}
.card .hd .title{font-weight:700}
.badge{
  font-size:12px;color:#cfe3ff;background:rgba(255,255,255,.06);
  border:1px solid var(--b);padding:6px 10px;border-radius:999px;
}
.card .bd{padding:14px 16px}
.small{color:var(--mut);font-size:13px}
hr.sep{border:0;border-top:1px solid var(--b);margin:12px 0}
.row{display:flex;gap:10px;flex-wrap:wrap}
.pill{
  padding:8px 10px;border-radius:999px;
  background:rgba(255,255,255,.05);
  border:1px solid var(--b);
  font-size:12px;color:#d7e6ff;
}
.kbd{font-family:var(--mono);font-size:12px;background:rgba(0,0,0,.25);border:1px solid var(--b);padding:2px 6px;border-radius:8px}
textarea{
  width:100%;min-height:110px;resize:vertical;
  background:rgba(0,0,0,.25);color:var(--txt);
  border:1px solid var(--b);border-radius:16px;
  padding:12px 12px;outline:none;
}
input[type="text"], input[type="password"], select{
  width:100%;
  background:rgba(0,0,0,.25);color:var(--txt);
  border:1px solid var(--b);border-radius:14px;
  padding:10px 12px;outline:none;
}
.btn{
  border:1px solid var(--b);
  background:rgba(255,255,255,.05);
  color:var(--txt);
  padding:10px 12px;border-radius:14px;
  cursor:pointer;transition:.15s;
}
.btn:hover{transform:translateY(-1px);border-color:var(--b2)}
.btn.primary{
  background:linear-gradient(135deg, rgba(124,92,255,.32), rgba(0,229,255,.18));
  border-color:rgba(124,92,255,.35);
}
.btn.danger{
  background:linear-gradient(135deg, rgba(255,59,106,.18), rgba(255,210,77,.08));
  border-color:rgba(255,59,106,.35);
}
.btn.good{
  background:linear-gradient(135deg, rgba(28,255,139,.16), rgba(0,229,255,.10));
  border-color:rgba(28,255,139,.30);
}
.chat{
  height:520px;overflow:auto;padding:14px 14px 10px;
  display:flex;flex-direction:column;gap:10px;
}
.msg{
  max-width:92%;
  padding:12px 12px;border-radius:16px;
  border:1px solid var(--b);
  background:rgba(0,0,0,.25);
  line-height:1.35;
  white-space:pre-wrap;
}
.msg.user{align-self:flex-end;border-color:rgba(0,229,255,.25);background:rgba(0,229,255,.06)}
.msg.ai{align-self:flex-start;border-color:rgba(124,92,255,.25);background:rgba(124,92,255,.06)}
.msg.sys{align-self:center;max-width:100%;opacity:.95;background:rgba(255,255,255,.04)}
.msg .meta{font-size:11px;color:var(--mut);margin-bottom:6px}
.chatbar{
  display:flex;gap:10px;padding:12px 14px;border-top:1px solid var(--b);
}
.chatbar textarea{min-height:52px;max-height:180px}
.chatbar .side{display:flex;flex-direction:column;gap:8px;min-width:170px}
@media (max-width:560px){.chatbar{flex-direction:column}.chatbar .side{min-width:unset;flex-direction:row;flex-wrap:wrap}}
.hidden{display:none !important}
.codebox{
  font-family:var(--mono);
  font-size:12px;
  background:rgba(0,0,0,.35);
  border:1px solid var(--b);
  border-radius:16px;
  padding:12px;
  overflow:auto;
  max-height:260px;
  white-space:pre;
}
.table{
  width:100%;
  border-collapse:collapse;
  overflow:hidden;
  border-radius:16px;
  border:1px solid var(--b);
}
.table th,.table td{
  padding:10px 10px;border-bottom:1px solid var(--b);
  text-align:left;font-size:13px;
}
.table th{color:#d9e7ff;background:rgba(255,255,255,.04)}
.table tr:last-child td{border-bottom:0}
.footer{
  margin-top:14px;
  color:var(--mut);
  font-size:12px;
  text-align:center;
  opacity:.9;
}
.note{
  padding:12px 12px;border-radius:16px;
  border:1px solid var(--b);
  background:rgba(255,255,255,.04);
}
.glow{
  box-shadow:0 0 0 1px rgba(124,92,255,.18), 0 0 40px rgba(124,92,255,.10);
}
</style>
</head>

<body>
<div class="wrap">
  <div class="topbar">
    <div class="brand">
      <div class="logo" aria-hidden="true">
        <svg width="24" height="24" viewBox="0 0 24 24" fill="none">
          <path d="M12 2l9 5v10l-9 5-9-5V7l9-5z" stroke="white" stroke-width="1.5"/>
          <path d="M7.5 10.5l4.5 2.5 4.5-2.5" stroke="white" stroke-width="1.5" stroke-linecap="round"/>
          <path d="M12 13v6.5" stroke="white" stroke-width="1.5" stroke-linecap="round"/>
        </svg>
      </div>
      <div>
        <h1>StudyBuddy AI ‚Äî Ultimate Hub</h1>
        <p class="sub">Super ChatGPT Clone + StudyBuddy AI (single-file)</p>
      </div>
    </div>

    <div class="nav" id="nav">
      <button class="active" data-page="home">Home</button>
      <button data-page="chat">Chat</button>
      <button data-page="tools">Tools</button>
      <button data-page="study">Study</button>
      <button data-page="games">Games</button>
      <button data-page="settings">Settings</button>
    </div>
  </div>

  <div class="grid">
    <!-- LEFT MAIN -->
    <div class="card glow">
      <div class="hd">
        <div class="title" id="pageTitle">Home</div>
        <div class="badge" id="statusBadge">Offline Mode ‚Ä¢ Local AI</div>
      </div>

      <div class="bd">
        <!-- HOME -->
        <div class="page" id="page-home">
          <div class="note">
            <b>Everything is working in one file.</b><br>
            Buttons work because all JS is inside this HTML.<br><br>
            <span class="small">Tip: Open in GitHub Pages OR double click locally.</span>
          </div>
          <hr class="sep">
          <div class="row">
            <span class="pill">‚úî No 404 errors</span>
            <span class="pill">‚úî showPage() fixed</span>
            <span class="pill">‚úî sbSend() fixed</span>
            <span class="pill">‚úî Super ChatGPT UI</span>
            <span class="pill">‚úî StudyBuddy Modes</span>
          </div>
          <hr class="sep">
          <div class="small">
            <b>Quick Start:</b><br>
            1) Go to <span class="kbd">Chat</span><br>
            2) Select mode (StudyBuddy / SuperChatGPT)<br>
            3) Type and press <span class="kbd">Enter</span>
          </div>
        </div>

        <!-- CHAT -->
        <div class="page hidden" id="page-chat">
          <div class="row" style="align-items:center;justify-content:space-between">
            <div class="small">
              <b>Mode:</b>
              <span class="pill" id="modePill">StudyBuddy</span>
              <span class="pill">Memory: Local</span>
              <span class="pill">History: Saved</span>
            </div>
            <div class="row">
              <button class="btn" id="btnExport">Export</button>
              <button class="btn danger" id="btnReset">Reset</button>
            </div>
          </div>

          <hr class="sep">

          <div class="chat" id="chatBox"></div>

          <div class="chatbar">
            <textarea id="chatInput" placeholder="Type message... (Enter = send, Shift+Enter = new line)"></textarea>
            <div class="side">
              <button class="btn primary" id="btnSend">Send</button>
              <button class="btn" id="btnMode">Switch Mode</button>
              <button class="btn good" id="btnSuggest">Suggest Prompt</button>
            </div>
          </div>
        </div>

        <!-- TOOLS -->
        <div class="page hidden" id="page-tools">
          <div class="row">
            <button class="btn primary" id="btnSummarize">Summarize Text</button>
            <button class="btn" id="btnRewrite">Rewrite</button>
            <button class="btn" id="btnExplain">Explain</button>
            <button class="btn" id="btnQuiz">Make Quiz</button>
          </div>
          <hr class="sep">
          <textarea id="toolInput" placeholder="Paste your text here..."></textarea>
          <hr class="sep">
          <div class="codebox" id="toolOutput">Output will appear here...</div>
        </div>

        <!-- STUDY -->
        <div class="page hidden" id="page-study">
          <div class="note">
            <b>StudyBuddy AI</b> has special modes:
            <ul class="small">
              <li>Teacher Mode</li>
              <li>Exam Mode</li>
              <li>Step-by-step Math</li>
              <li>Code Helper</li>
              <li>Language Tutor</li>
            </ul>
          </div>
          <hr class="sep">
          <div class="row">
            <button class="btn primary" data-setmode="Teacher">Teacher Mode</button>
            <button class="btn" data-setmode="Exam">Exam Mode</button>
            <button class="btn" data-setmode="Math">Math Mode</button>
            <button class="btn" data-setmode="Coding">Coding Mode</button>
            <button class="btn" data-setmode="Language">Language Mode</button>
          </div>
          <hr class="sep">
          <div class="small">These modes affect how the AI responds in Chat.</div>
        </div>

        <!-- GAMES -->
        <div class="page hidden" id="page-games">
          <div class="note">
            <b>Games Hub</b> (this is where you can add PRO MINECRAFT GAME later).
            <br><span class="small">For now: simple mini-games included.</span>
          </div>
          <hr class="sep">
          <div class="row">
            <button class="btn primary" id="btnGameDice">Dice</button>
            <button class="btn" id="btnGameRPS">Rock Paper Scissors</button>
            <button class="btn" id="btnGameGuess">Number Guess</button>
          </div>
          <hr class="sep">
          <div class="codebox" id="gameBox">Click a game button...</div>
        </div>

        <!-- SETTINGS -->
        <div class="page hidden" id="page-settings">
          <div class="note">
            <b>Settings</b><br>
            Everything is local. Works on GitHub Pages.
          </div>
          <hr class="sep">
          <div class="row">
            <div style="flex:1;min-width:240px">
              <label class="small"><b>Theme</b></label>
              <select id="themeSel">
                <option value="neo">Neo Dark</option>
                <option value="midnight">Midnight</option>
                <option value="matrix">Matrix Green</option>
              </select>
            </div>
            <div style="flex:1;min-width:240px">
              <label class="small"><b>Chat Name</b></label>
              <input id="userName" type="text" placeholder="Your name..." />
            </div>
          </div>
          <hr class="sep">
          <div class="row">
            <button class="btn primary" id="btnSaveSettings">Save</button>
            <button class="btn" id="btnClearStorage">Clear All Storage</button>
          </div>
          <hr class="sep">
          <div class="small">
            Saved in: <span class="kbd">localStorage</span>
          </div>
        </div>

      </div>
    </div>

    <!-- RIGHT PANEL -->
    <div class="card">
      <div class="hd">
        <div class="title">Super ChatGPT + StudyBuddy</div>
        <div class="badge" id="rightBadge">All-in-One</div>
      </div>
      <div class="bd">
        <div class="small">
          <b>Built-in Commands (Chat):</b>
        </div>
        <table class="table" style="margin-top:10px">
          <tr><th>Command</th><th>What it does</th></tr>
          <tr><td><span class="kbd">/help</span></td><td>Shows commands</td></tr>
          <tr><td><span class="kbd">/mode</span></td><td>Switch StudyBuddy/SuperChatGPT</td></tr>
          <tr><td><span class="kbd">/teacher</span></td><td>Teacher mode</td></tr>
          <tr><td><span class="kbd">/exam</span></td><td>Exam mode</td></tr>
          <tr><td><span class="kbd">/math</span></td><td>Math mode</td></tr>
          <tr><td><span class="kbd">/coding</span></td><td>Coding mode</td></tr>
          <tr><td><span class="kbd">/reset</span></td><td>Clear chat</td></tr>
          <tr><td><span class="kbd">/export</span></td><td>Download chat json</td></tr>
        </table>

        <hr class="sep">

        <div class="small"><b>Why your old one broke:</b></div>
        <div class="small" style="margin-top:8px">
          It said: <span class="kbd">showPage is not defined</span> and <span class="kbd">sbSend is not defined</span>.<br>
          That happens when JavaScript file is missing (404).<br><br>
          <b>This file has NO external JS</b> so it never breaks.
        </div>
      </div>
    </div>
  </div>

  <div class="footer">
    StudyBuddy AI Ultimate Hub ‚Ä¢ Single File ‚Ä¢ Works on GitHub Pages
  </div>
</div>

<script>
/* =========================
   SINGLE FILE APP (NO 404)
   ========================= */

/* ---------- Storage Keys ---------- */
const K = {
  chat: "SBH_CHAT_V1",
  settings: "SBH_SETTINGS_V1"
};

/* ---------- State ---------- */
let STATE = {
  appMode: "StudyBuddy",        // StudyBuddy | SuperChatGPT
  sbSubMode: "Teacher",         // Teacher | Exam | Math | Coding | Language
  userName: "You",
  theme: "neo",
  chat: []
};

/* ---------- Helpers ---------- */
const $ = (id)=>document.getElementById(id);
const nowTime = ()=> new Date().toLocaleTimeString([], {hour:"2-digit", minute:"2-digit"});
const safe = (s)=> String(s ?? "").replace(/[<>&]/g, m=>({ "<":"&lt;", ">":"&gt;", "&":"&amp;" }[m]));

/* ---------- Load / Save ---------- */
function loadAll(){
  try{
    const s = JSON.parse(localStorage.getItem(K.settings) || "{}");
    STATE.userName = s.userName || "You";
    STATE.theme = s.theme || "neo";
    STATE.appMode = s.appMode || "StudyBuddy";
    STATE.sbSubMode = s.sbSubMode || "Teacher";
  }catch(e){}
  try{
    STATE.chat = JSON.parse(localStorage.getItem(K.chat) || "[]");
    if(!Array.isArray(STATE.chat)) STATE.chat=[];
  }catch(e){ STATE.chat=[]; }
}
function saveAll(){
  localStorage.setItem(K.settings, JSON.stringify({
    userName: STATE.userName,
    theme: STATE.theme,
    appMode: STATE.appMode,
    sbSubMode: STATE.sbSubMode
  }));
  localStorage.setItem(K.chat, JSON.stringify(STATE.chat));
}

/* ---------- Theme ---------- */
function applyTheme(){
  const t = STATE.theme;
  const root = document.documentElement;
  if(t==="neo"){
    root.style.setProperty("--pri","#7c5cff");
    root.style.setProperty("--pri2","#00e5ff");
    root.style.setProperty("--bg","#070b12");
  }
  if(t==="midnight"){
    root.style.setProperty("--pri","#4c7dff");
    root.style.setProperty("--pri2","#00ffc6");
    root.style.setProperty("--bg","#04060c");
  }
  if(t==="matrix"){
    root.style.setProperty("--pri","#00ff66");
    root.style.setProperty("--pri2","#00e5ff");
    root.style.setProperty("--bg","#030806");
  }
}

/* ---------- Navigation ---------- */
function showPage(page){
  // nav buttons
  document.querySelectorAll("#nav button").forEach(b=>{
    b.classList.toggle("active", b.dataset.page===page);
  });
  // pages
  document.querySelectorAll(".page").forEach(p=>p.classList.add("hidden"));
  const el = $("page-"+page);
  if(el) el.classList.remove("hidden");

  // title
  const titleMap = {
    home:"Home",
    chat:"Chat",
    tools:"Tools",
    study:"Study",
    games:"Games",
    settings:"Settings"
  };
  $("pageTitle").textContent = titleMap[page] || "Home";
}

/* ---------- Chat Rendering ---------- */
function addMsg(role, text){
  const item = { role, text, t: Date.now() };
  STATE.chat.push(item);
  saveAll();
  renderChat();
  scrollChatBottom();
}
function renderChat(){
  const box = $("chatBox");
  box.innerHTML = "";

  if(STATE.chat.length===0){
    const d = document.createElement("div");
    d.className="msg sys";
    d.innerHTML = `<div class="meta">System</div>Welcome! Type <b>/help</b> to see commands.`;
    box.appendChild(d);
    return;
  }

  for(const m of STATE.chat){
    const div = document.createElement("div");
    div.className = "msg " + (m.role==="user" ? "user" : (m.role==="ai" ? "ai":"sys"));
    const metaName = (m.role==="user") ? STATE.userName : (m.role==="ai" ? (STATE.appMode==="StudyBuddy" ? "StudyBuddy AI" : "Super ChatGPT") : "System");
    div.innerHTML = `<div class="meta">${safe(metaName)} ‚Ä¢ ${new Date(m.t).toLocaleTimeString([], {hour:"2-digit", minute:"2-digit"})}</div>${safe(m.text)}`;
    box.appendChild(div);
  }
}
function scrollChatBottom(){
  const box = $("chatBox");
  box.scrollTop = box.scrollHeight;
}

/* ---------- AI Logic (Offline Local) ---------- */
function aiReply(userText){
  const txt = userText.trim();

  // Commands
  if(txt.startsWith("/")){
    return handleCommand(txt);
  }

  // StudyBuddy vs SuperChatGPT styles
  if(STATE.appMode==="StudyBuddy"){
    return studyBuddyBrain(txt);
  }else{
    return superChatGPTBrain(txt);
  }
}

function handleCommand(cmd){
  const c = cmd.toLowerCase().trim();

  if(c==="/help"){
    return `Commands:
- /help
- /mode
- /teacher /exam /math /coding /language
- /reset
- /export`;
  }
  if(c==="/mode"){
    STATE.appMode = (STATE.appMode==="StudyBuddy") ? "SuperChatGPT" : "StudyBuddy";
    saveAll();
    updateBadges();
    return `Switched mode to: ${STATE.appMode}`;
  }
  if(c==="/teacher"){STATE.sbSubMode="Teacher"; saveAll(); updateBadges(); return "StudyBuddy sub-mode: Teacher";}
  if(c==="/exam"){STATE.sbSubMode="Exam"; saveAll(); updateBadges(); return "StudyBuddy sub-mode: Exam";}
  if(c==="/math"){STATE.sbSubMode="Math"; saveAll(); updateBadges(); return "StudyBuddy sub-mode: Math";}
  if(c==="/coding"){STATE.sbSubMode="Coding"; saveAll(); updateBadges(); return "StudyBuddy sub-mode: Coding";}
  if(c==="/language"){STATE.sbSubMode="Language"; saveAll(); updateBadges(); return "StudyBuddy sub-mode: Language";}

  if(c==="/reset"){
    STATE.chat=[];
    saveAll();
    renderChat();
    return "Chat cleared.";
  }
  if(c==="/export"){
    exportChat();
    return "Exporting chat...";
  }

  return "Unknown command. Type /help";
}

function studyBuddyBrain(t){
  const mode = STATE.sbSubMode;

  if(mode==="Teacher"){
    return `Teacher Mode ‚úÖ

Explain: ${t}

1) Simple meaning:
- ${simpleExplain(t)}

2) Example:
- ${makeExample(t)}

3) Quick check:
- Do you want a quiz on this?`;
  }

  if(mode==="Exam"){
    return `Exam Mode üìù

Question topic: ${t}

Answer format:
- Short answer
- Key points
- 1 example

Key points:
- ${keyPoints(t).join("\n- ")}`;
  }

  if(mode==="Math"){
    return `Math Mode ‚ûó

Problem: ${t}

Step-by-step:
1) Identify what is given
2) Choose formula
3) Solve

(If you paste the exact numbers, I will solve it fully.)`;
  }

  if(mode==="Coding"){
    return `Coding Mode üíª

Request: ${t}

I can:
- Fix code
- Explain code
- Write code
- Debug errors

Paste your code and I will improve it.`;
  }

  if(mode==="Language"){
    return `Language Mode üåç

Text: ${t}

I can:
- Translate
- Correct grammar
- Improve writing
- Teach vocabulary`;
  }

  return `StudyBuddy: ${t}`;
}

function superChatGPTBrain(t){
  // More "chatgpt clone" style
  if(/hello|hi|hey/i.test(t)) return "Hey! üòÑ I‚Äôm Super ChatGPT inside StudyBuddy Hub. What do you want to do today?";
  if(/make.*website|html|css|js/i.test(t)) return "Sure. Tell me what you want in the website and I will generate the full code.";
  if(/minecraft/i.test(t)) return "I can add PRO MINECRAFT GAME as a full web mini-game module inside the Games tab.";
  return `Super ChatGPT ü§ñ

You said:
"${t}"

Reply:
- I understand. Tell me the next instruction and I will do it.`;
}

/* ---------- Mini Helpers ---------- */
function simpleExplain(x){
  if(x.length<20) return `This is about: "${x}".`;
  return "This topic means understanding the main idea and how it works.";
}
function makeExample(x){
  return `Example: If we apply "${x}" in real life, we can solve problems faster.`;
}
function keyPoints(x){
  return [
    `Main idea of "${x}"`,
    "Definition + explanation",
    "One example",
    "One common mistake"
  ];
}

/* ---------- Chat Actions ---------- */
function sbSend(){
  const input = $("chatInput");
  const text = input.value.trim();
  if(!text) return;

  input.value = "";
  addMsg("user", text);

  // AI response
  setTimeout(()=>{
    const reply = aiReply(text);
    addMsg("ai", reply);
  }, 120);
}

function sbReset(){
  if(!confirm("Reset chat?")) return;
  STATE.chat=[];
  saveAll();
  renderChat();
}

function sbExport(){
  exportChat();
}

/* ---------- Export ---------- */
function exportChat(){
  const data = {
    exportedAt: new Date().toISOString(),
    appMode: STATE.appMode,
    sbSubMode: STATE.sbSubMode,
    userName: STATE.userName,
    chat: STATE.chat
  };
  const blob = new Blob([JSON.stringify(data,null,2)], {type:"application/json"});
  const url = URL.createObjectURL(blob);
  const a = document.createElement("a");
  a.href = url;
  a.download = "StudyBuddyHub_ChatExport.json";
  document.body.appendChild(a);
  a.click();
  a.remove();
  setTimeout(()=>URL.revokeObjectURL(url), 1000);
}

/* ---------- Badges ---------- */
function updateBadges(){
  $("modePill").textContent = STATE.appMode + (STATE.appMode==="StudyBuddy" ? (" ‚Ä¢ "+STATE.sbSubMode) : "");
  $("statusBadge").textContent = "Offline Mode ‚Ä¢ " + STATE.appMode;
}

/* ---------- Tools ---------- */
function toolRun(type){
  const input = $("toolInput").value.trim();
  if(!input){ $("toolOutput").textContent="Paste text first."; return; }

  if(type==="summarize"){
    $("toolOutput").textContent = "Summary:\n- " + input.split(/\s+/).slice(0,40).join(" ") + (input.split(/\s+/).length>40?" ...":"");
  }
  if(type==="rewrite"){
    $("toolOutput").textContent = "Rewrite:\n" + input.replace(/\bvery\b/gi,"really").replace(/\bI\b/g,"I (rewritten)");
  }
  if(type==="explain"){
    $("toolOutput").textContent = "Explanation:\nThis text is about:\n" + simpleExplain(input);
  }
  if(type==="quiz"){
    $("toolOutput").textContent =
`Quiz:
1) What is the main idea of the text?
2) Write 3 key points.
3) Give 1 example.
4) What mistake can happen?`;
  }
}

/* ---------- Games ---------- */
let guessNumber = null;
function gameDice(){
  const a = 1 + Math.floor(Math.random()*6);
  const b = 1 + Math.floor(Math.random()*6);
  $("gameBox").textContent = `üé≤ Dice rolled: ${a} and ${b}\nTotal: ${a+b}`;
}
function gameRPS(){
  const items=["Rock","Paper","Scissors"];
  const pick = items[Math.floor(Math.random()*3)];
  $("gameBox").textContent = `‚úä‚úã‚úåÔ∏è Random pick: ${pick}\nTry again!`;
}
function gameGuess(){
  if(guessNumber===null) guessNumber = 1 + Math.floor(Math.random()*50);
  const g = prompt("Guess number (1 to 50):");
  if(g===null) return;
  const n = Number(g);
  if(!Number.isFinite(n)) { $("gameBox").textContent="Not a number."; return; }
  if(n===guessNumber){ $("gameBox").textContent="üéâ Correct! New number generated."; guessNumber=null; return; }
  $("gameBox").textContent = (n<guessNumber) ? "Too low!" : "Too high!";
}

/* ---------- Init ---------- */
function init(){
  loadAll();
  applyTheme();

  // Settings UI
  $("themeSel").value = STATE.theme;
  $("userName").value = STATE.userName;

  // Nav events
  document.querySelectorAll("#nav button").forEach(btn=>{
    btn.addEventListener("click", ()=> showPage(btn.dataset.page));
  });

  // Chat events
  $("btnSend").addEventListener("click", sbSend);
  $("btnReset").addEventListener("click", sbReset);
  $("btnExport").addEventListener("click", sbExport);
  $("btnMode").addEventListener("click", ()=>{
    STATE.appMode = (STATE.appMode==="StudyBuddy") ? "SuperChatGPT" : "StudyBuddy";
    saveAll(); updateBadges();
    addMsg("sys", "Mode switched to: " + STATE.appMode);
  });
  $("btnSuggest").addEventListener("click", ()=>{
    const suggestions = [
      "Explain photosynthesis in simple words.",
      "Make me a quiz about Newton laws.",
      "Write a website landing page.",
      "Help me with JavaScript errors.",
      "Make a study plan for exams."
    ];
    $("chatInput").value = suggestions[Math.floor(Math.random()*suggestions.length)];
    $("chatInput").focus();
  });

  $("chatInput").addEventListener("keydown", (e)=>{
    if(e.key==="Enter" && !e.shiftKey){
      e.preventDefault();
      sbSend();
    }
  });

  // Study mode buttons
  document.querySelectorAll("[data-setmode]").forEach(b=>{
    b.addEventListener("click", ()=>{
      STATE.appMode="StudyBuddy";
      STATE.sbSubMode=b.dataset.setmode;
      saveAll();
      updateBadges();
      showPage("chat");
      addMsg("sys", "StudyBuddy mode set to: " + STATE.sbSubMode);
    });
  });

  // Tools buttons
  $("btnSummarize").addEventListener("click", ()=>toolRun("summarize"));
  $("btnRewrite").addEventListener("click", ()=>toolRun("rewrite"));
  $("btnExplain").addEventListener("click", ()=>toolRun("explain"));
  $("btnQuiz").addEventListener("click", ()=>toolRun("quiz"));

  // Games
  $("btnGameDice").addEventListener("click", gameDice);
  $("btnGameRPS").addEventListener("click", gameRPS);
  $("btnGameGuess").addEventListener("click", gameGuess);

  // Settings
  $("btnSaveSettings").addEventListener("click", ()=>{
    STATE.theme = $("themeSel").value;
    STATE.userName = $("userName").value.trim() || "You";
    saveAll();
    applyTheme();
    addMsg("sys", "Settings saved.");
  });
  $("btnClearStorage").addEventListener("click", ()=>{
    if(!confirm("Clear EVERYTHING?")) return;
    localStorage.removeItem(K.chat);
    localStorage.removeItem(K.settings);
    location.reload();
  });

  // First render
  updateBadges();
  renderChat();
  showPage("home");
}
init();
</script>
</body>
</html>
