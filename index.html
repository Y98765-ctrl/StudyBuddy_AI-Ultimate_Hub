<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width,initial-scale=1.0" />
<title>StudyBuddy AI - Ultimate Hub</title>
<style>
:root{
  --bg:#0b1225;
  --card:#111a33;
  --card2:#0f1830;
  --text:#ffffff;
  --muted:#aab3c7;
  --accent:#22c55e;
  --accent2:#2563eb;
  --danger:#ef4444;
  --line:rgba(255,255,255,0.08);
}
.light{
  --bg:#f3f4f6;
  --card:#ffffff;
  --card2:#f8fafc;
  --text:#0b1225;
  --muted:#5b6477;
  --accent:#16a34a;
  --accent2:#2563eb;
  --danger:#dc2626;
  --line:rgba(0,0,0,0.08);
}
*{box-sizing:border-box}
body{
  margin:0;
  background:var(--bg);
  color:var(--text);
  font-family:Arial,Helvetica,sans-serif;
  display:flex;
  justify-content:center;
}
.app{
  width:100%;
  max-width:1100px;
  min-height:100vh;
  display:flex;
  gap:12px;
  padding:12px;
}
.sidebar{
  width:280px;
  min-width:260px;
  background:var(--card);
  border:1px solid var(--line);
  border-radius:16px;
  padding:12px;
  display:flex;
  flex-direction:column;
  gap:10px;
}
.brand{
  display:flex;
  align-items:center;
  justify-content:space-between;
  gap:10px;
  padding:8px 10px;
  border-radius:12px;
  background:linear-gradient(135deg, rgba(34,197,94,0.15), rgba(37,99,235,0.12));
  border:1px solid var(--line);
}
.brand b{font-size:14px}
.brand small{color:var(--muted);display:block;margin-top:2px;font-size:11px}
.iconBtn{
  border:none;
  background:transparent;
  color:var(--text);
  cursor:pointer;
  font-size:18px;
}
.nav{
  display:flex;
  flex-direction:column;
  gap:8px;
}
.nav button{
  width:100%;
  padding:10px 12px;
  border:none;
  border-radius:12px;
  cursor:pointer;
  background:var(--card2);
  color:var(--text);
  border:1px solid var(--line);
  text-align:left;
  font-size:14px;
}
.nav button.active{
  outline:2px solid rgba(34,197,94,0.35);
  border-color:rgba(34,197,94,0.35);
}
.sideTools{
  margin-top:auto;
  display:flex;
  gap:8px;
}
.sideTools button{
  flex:1;
  padding:10px;
  border:none;
  border-radius:12px;
  cursor:pointer;
  background:var(--card2);
  color:var(--text);
  border:1px solid var(--line);
}
.main{
  flex:1;
  display:flex;
  flex-direction:column;
  gap:12px;
}
.topbar{
  background:var(--card);
  border:1px solid var(--line);
  border-radius:16px;
  padding:12px;
  display:flex;
  justify-content:space-between;
  align-items:center;
  gap:10px;
}
.topbar .title{
  display:flex;
  flex-direction:column;
  gap:2px;
}
.topbar .title b{font-size:15px}
.topbar .title span{font-size:12px;color:var(--muted)}
.pill{
  padding:8px 10px;
  border-radius:999px;
  border:1px solid var(--line);
  background:var(--card2);
  color:var(--muted);
  font-size:12px;
}
.page{
  display:none;
  flex:1;
  background:var(--card);
  border:1px solid var(--line);
  border-radius:16px;
  overflow:hidden;
}
.page.active{display:flex}
.pageInner{
  flex:1;
  display:flex;
  flex-direction:column;
  height:100%;
}
.sectionHead{
  padding:12px;
  border-bottom:1px solid var(--line);
  display:flex;
  justify-content:space-between;
  align-items:center;
  gap:10px;
}
.sectionHead b{font-size:14px}
.sectionHead .right{
  display:flex;
  gap:8px;
  align-items:center;
}
.sectionHead button{
  padding:8px 10px;
  border:none;
  border-radius:10px;
  cursor:pointer;
  background:var(--card2);
  color:var(--text);
  border:1px solid var(--line);
}
.content{
  flex:1;
  overflow:auto;
  padding:12px;
}
.card{
  background:var(--card2);
  border:1px solid var(--line);
  border-radius:14px;
  padding:12px;
  margin-bottom:10px;
}
.grid2{
  display:grid;
  grid-template-columns:repeat(2, minmax(0,1fr));
  gap:10px;
}
@media(max-width:900px){
  .app{flex-direction:column}
  .sidebar{width:100%;min-width:unset}
}
.chatWrap{
  display:flex;
  flex-direction:column;
  height:100%;
}
.chatLog{
  flex:1;
  overflow:auto;
  padding:12px;
  display:flex;
  flex-direction:column;
  gap:8px;
}
.msg{
  max-width:80%;
  padding:10px 12px;
  border-radius:14px;
  white-space:pre-wrap;
  line-height:1.35;
  border:1px solid var(--line);
}
.msg.user{align-self:flex-end;background:rgba(37,99,235,0.22)}
.msg.bot{align-self:flex-start;background:rgba(31,41,55,0.35)}
.light .msg.bot{background:rgba(0,0,0,0.06)}
.chatInput{
  display:flex;
  gap:8px;
  padding:12px;
  border-top:1px solid var(--line);
}
.chatInput input{
  flex:1;
  padding:12px;
  border-radius:12px;
  border:1px solid var(--line);
  outline:none;
  background:var(--card2);
  color:var(--text);
}
.chatInput button{
  padding:12px 14px;
  border:none;
  border-radius:12px;
  cursor:pointer;
  background:var(--accent);
  color:#07120a;
  font-weight:bold;
}
.kbd{
  font-family:monospace;
  font-size:12px;
  color:var(--muted);
}
.gameList{
  display:grid;
  grid-template-columns:repeat(2, minmax(0,1fr));
  gap:10px;
}
.gameBtn{
  padding:12px;
  border-radius:14px;
  border:1px solid var(--line);
  background:var(--card2);
  color:var(--text);
  cursor:pointer;
  text-align:left;
}
.gameBtn:hover{outline:2px solid rgba(37,99,235,0.22)}
.badge{
  display:inline-block;
  padding:4px 8px;
  border-radius:999px;
  background:rgba(34,197,94,0.18);
  border:1px solid rgba(34,197,94,0.25);
  color:var(--text);
  font-size:11px;
}
hr.sep{border:none;border-top:1px solid var(--line);margin:10px 0}
.small{color:var(--muted);font-size:12px}
.danger{background:var(--danger)!important;color:#fff!important}
</style>
</head>

<body>
<div class="app">

  <aside class="sidebar">
    <div class="brand">
      <div>
        <b>StudyBuddy AI</b>
        <small>Ultimate Hub ‚Ä¢ Offline</small>
      </div>
      <button class="iconBtn" id="themeBtn" type="button" title="Theme">üåó</button>
    </div>

    <div class="nav">
      <button type="button" class="active" data-page="studybuddy">ü§ñ StudyBuddy AI</button>
      <button type="button" data-page="gameshub">üéÆ Infinity Games Hub</button>
      <button type="button" data-page="minecraft">‚õèÔ∏è Pro Minecraft (Mini)</button>
      <button type="button" data-page="chatterly">üí¨ Chatterly (Offline)</button>
      <button type="button" data-page="supergpt">üß† Super ChatGPT Clone</button>
      <button type="button" data-page="settings">‚öôÔ∏è Settings</button>
    </div>

    <div class="sideTools">
      <button type="button" id="exportBtn">‚¨á Export</button>
      <button type="button" id="resetBtn" class="danger">Reset</button>
    </div>
  </aside>

  <main class="main">
    <div class="topbar">
      <div class="title">
        <b id="topTitle">StudyBuddy AI</b>
        <span id="topSub">All-in-one hub (single file). No service worker.</span>
      </div>
      <div class="pill" id="statusPill">Ready</div>
    </div>

    <!-- ===================== StudyBuddy AI ===================== -->
    <section class="page active" id="page-studybuddy">
      <div class="pageInner chatWrap">
        <div class="sectionHead">
          <b>ü§ñ StudyBuddy AI</b>
          <div class="right">
            <span class="kbd">Modes:</span>
            <button type="button" data-mode="chat">üí¨ Chat</button>
            <button type="button" data-mode="math">‚ûó Math</button>
            <button type="button" data-mode="quiz">üß† Quiz</button>
            <button type="button" data-mode="islam">üïå Islam</button>
          </div>
        </div>

        <div class="chatLog" id="sbChat"></div>

        <div class="chatInput">
          <input id="sbInput" placeholder="Type here..." />
          <button type="button" id="sbSendBtn">‚ñ∂</button>
        </div>
      </div>
    </section>

    <!-- ===================== Games Hub ===================== -->
    <section class="page" id="page-gameshub">
      <div class="pageInner">
        <div class="sectionHead">
          <b>üéÆ Infinity Games Hub</b>
          <div class="right">
            <input id="gameSearch" placeholder="Search games..." style="padding:8px 10px;border-radius:10px;border:1px solid var(--line);background:var(--card2);color:var(--text);outline:none" />
            <button type="button" id="reloadGames">‚Üª Reload</button>
          </div>
        </div>
        <div class="content">
          <div class="card">
            <b>Unlimited Game List</b>
            <div class="small">Click any game. (Demo mode)</div>
          </div>
          <div class="gameList" id="gameList"></div>
        </div>
      </div>
    </section>

    <!-- ===================== Minecraft Mini ===================== -->
    <section class="page" id="page-minecraft">
      <div class="pageInner">
        <div class="sectionHead">
          <b>‚õèÔ∏è Pro Minecraft (Mini)</b>
          <div class="right">
            <span class="badge" id="mcBadge">Single Player</span>
            <button type="button" id="mcNewWorld">New World</button>
          </div>
        </div>

        <div class="content">
          <div class="card">
            <b>World</b>
            <div class="small">
              Controls: WASD / Arrow keys to move ‚Ä¢ Click tiles to mine/build.
            </div>
            <hr class="sep">
            <canvas id="mcCanvas" width="760" height="420" style="width:100%;max-width:100%;border-radius:14px;border:1px solid var(--line);background:#081028"></canvas>
          </div>

          <div class="grid2">
            <div class="card">
              <b>Player</b>
              <div id="mcStats" class="small"></div>
              <hr class="sep">
              <button type="button" id="mcHeal" style="width:100%;padding:10px;border-radius:12px;border:1px solid var(--line);background:var(--accent);cursor:pointer;font-weight:bold">Heal</button>
            </div>
            <div class="card">
              <b>Commands</b>
              <div class="small">Type commands like:</div>
              <div class="small"><span class="kbd">/kill</span> ‚Ä¢ <span class="kbd">/revive</span> ‚Ä¢ <span class="kbd">/destroyworld</span></div>
              <hr class="sep">
              <input id="mcCmd" placeholder="/command" style="width:100%;padding:10px;border-radius:12px;border:1px solid var(--line);background:var(--card2);color:var(--text);outline:none">
              <button type="button" id="mcRunCmd" style="margin-top:8px;width:100%;padding:10px;border-radius:12px;border:1px solid var(--line);background:var(--accent2);color:#fff;cursor:pointer">Run</button>
              <div id="mcOut" class="small" style="margin-top:8px"></div>
            </div>
          </div>

          <div class="card">
            <b>Boss System (Infinite)</b>
            <div class="small">
              Bosses respawn forever. Defeat count saves in this session.
            </div>
            <hr class="sep">
            <button type="button" id="mcSpawnBoss" style="padding:10px;border-radius:12px;border:1px solid var(--line);background:var(--card2);color:var(--text);cursor:pointer">Spawn Boss</button>
            <button type="button" id="mcAttackBoss" style="padding:10px;border-radius:12px;border:1px solid var(--line);background:var(--accent);cursor:pointer;font-weight:bold">Attack</button>
            <div id="mcBoss" class="small" style="margin-top:8px"></div>
          </div>

        </div>
      </div>
    </section>

    <!-- ===================== Chatterly Offline ===================== -->
    <section class="page" id="page-chatterly">
      <div class="pageInner">
        <div class="sectionHead">
          <b>üí¨ Chatterly (Offline)</b>
          <div class="right">
            <span class="badge">No Firebase</span>
            <button type="button" id="chLogout">Logout</button>
          </div>
        </div>

        <div class="content">
          <div class="card" id="chLoginCard">
            <b>Login</b>
            <div class="small">Offline demo (local accounts stored in browser).</div>
            <hr class="sep">
            <input id="chEmail" placeholder="Email" style="width:100%;padding:10px;border-radius:12px;border:1px solid var(--line);background:var(--card2);color:var(--text);outline:none;margin-bottom:8px">
            <input id="chPass" placeholder="Password" type="password" style="width:100%;padding:10px;border-radius:12px;border:1px solid var(--line);background:var(--card2);color:var(--text);outline:none;margin-bottom:8px">
            <div style="display:flex;gap:8px">
              <button type="button" id="chLogin" style="flex:1;padding:10px;border-radius:12px;border:1px solid var(--line);background:var(--accent2);color:#fff;cursor:pointer">Login</button>
              <button type="button" id="chSignup" style="flex:1;padding:10px;border-radius:12px;border:1px solid var(--line);background:var(--card2);color:var(--text);cursor:pointer">Sign Up</button>
            </div>
            <div id="chMsg" class="small" style="margin-top:10px"></div>
          </div>

          <div class="card" id="chChatCard" style="display:none">
            <b>Chat Room</b>
            <div class="small">Local multi-user on same browser.</div>
            <hr class="sep">
            <div id="chMessages" style="height:260px;overflow:auto;border-radius:12px;border:1px solid var(--line);padding:10px;background:rgba(0,0,0,0.12)"></div>
            <div style="display:flex;gap:8px;margin-top:10px">
              <input id="chInput" placeholder="Type message..." style="flex:1;padding:10px;border-radius:12px;border:1px solid var(--line);background:var(--card2);color:var(--text);outline:none">
              <button type="button" id="chSend" style="padding:10px 14px;border-radius:12px;border:1px solid var(--line);background:var(--accent);cursor:pointer;font-weight:bold">Send</button>
            </div>
          </div>

        </div>
      </div>
    </section>

    <!-- ===================== Super GPT Clone ===================== -->
    <section class="page" id="page-supergpt">
      <div class="pageInner chatWrap">
        <div class="sectionHead">
          <b>üß† Super ChatGPT Clone</b>
          <div class="right">
            <button type="button" id="sgNewChat">+ New Chat</button>
            <button type="button" id="sgDark">Toggle Dark</button>
          </div>
        </div>

        <div class="chatLog" id="sgChat"></div>

        <div class="chatInput">
          <input id="sgInput" placeholder="Type a message..." />
          <button type="button" id="sgSend">Send</button>
        </div>
      </div>
    </section>

    <!-- ===================== Settings ===================== -->
    <section class="page" id="page-settings">
      <div class="pageInner">
        <div class="sectionHead">
          <b>‚öôÔ∏è Settings</b>
          <div class="right">
            <span class="badge">Single File</span>
          </div>
        </div>
        <div class="content">
          <div class="card">
            <b>App Name</b>
            <div class="small">StudyBuddy AI - Ultimate Hub</div>
          </div>
          <div class="card">
            <b>Fix for your error</b>
            <div class="small">
              All buttons now work because functions are defined and event listeners are used.
            </div>
          </div>
          <div class="card">
            <b>Data Storage</b>
            <div class="small">
              Uses localStorage only (offline). No service worker. No Firebase.
            </div>
          </div>
        </div>
      </div>
    </section>

  </main>
</div>

<script>
/* =========================
   GLOBAL HELPERS
========================= */
const $ = (id)=>document.getElementById(id);
const qs = (sel)=>document.querySelector(sel);
const qsa = (sel)=>document.querySelectorAll(sel);

function setStatus(t){ $("statusPill").textContent = t; }

function escapeHTML(s){
  return (s+"").replaceAll("&","&amp;").replaceAll("<","&lt;").replaceAll(">","&gt;");
}

/* =========================
   NAVIGATION (NO INLINE)
========================= */
const pageMap = {
  studybuddy: {id:"page-studybuddy", title:"StudyBuddy AI", sub:"Chat + Math + Quiz + Islam"},
  gameshub:   {id:"page-gameshub", title:"Infinity Games Hub", sub:"Unlimited games list (demo)"},
  minecraft:  {id:"page-minecraft", title:"Pro Minecraft (Mini)", sub:"Mini world + bosses + commands"},
  chatterly:  {id:"page-chatterly", title:"Chatterly (Offline)", sub:"Local accounts + local chat"},
  supergpt:   {id:"page-supergpt", title:"Super ChatGPT Clone", sub:"Offline rule-based clone"},
  settings:   {id:"page-settings", title:"Settings", sub:"Theme + export + reset"}
};

function showPage(key){
  qsa(".page").forEach(p=>p.classList.remove("active"));
  qsa(".nav button").forEach(b=>b.classList.remove("active"));

  const info = pageMap[key];
  if(!info) return;

  $(info.id).classList.add("active");
  qsa(".nav button").forEach(b=>{
    if(b.dataset.page===key) b.classList.add("active");
  });

  $("topTitle").textContent = info.title;
  $("topSub").textContent = info.sub;
  setStatus("Ready");
}

qsa(".nav button").forEach(btn=>{
  btn.addEventListener("click", ()=>showPage(btn.dataset.page));
});

/* =========================
   THEME
========================= */
function toggleTheme(){
  document.body.classList.toggle("light");
  localStorage.setItem("SB_THEME", document.body.classList.contains("light") ? "light" : "dark");
}
$("themeBtn").addEventListener("click", toggleTheme);

(function initTheme(){
  const t = localStorage.getItem("SB_THEME") || "dark";
  if(t==="light") document.body.classList.add("light");
})();

/* =========================
   EXPORT + RESET
========================= */
$("exportBtn").addEventListener("click", ()=>{
  const sb = JSON.parse(localStorage.getItem("SB_CHAT")||"[]");
  const sg = JSON.parse(localStorage.getItem("SG_CHAT")||"[]");
  const ch = JSON.parse(localStorage.getItem("CH_MSGS")||"[]");
  const data = {
    app:"StudyBuddy AI - Ultimate Hub",
    exportedAt:new Date().toISOString(),
    studybuddy:sb,
    supergpt:sg,
    chatterly:ch
  };
  const blob = new Blob([JSON.stringify(data,null,2)], {type:"application/json"});
  const a = document.createElement("a");
  a.href = URL.createObjectURL(blob);
  a.download = "studybuddy_export.json";
  a.click();
  setStatus("Exported");
});

$("resetBtn").addEventListener("click", ()=>{
  if(!confirm("Reset everything?")) return;
  localStorage.clear();
  location.reload();
});

/* =========================
   STUDYBUDDY AI
========================= */
let sbMode = "chat";
const sbChat = $("sbChat");
const sbInput = $("sbInput");

function sbAdd(text, who){
  const d = document.createElement("div");
  d.className = "msg " + who;
  d.textContent = text;
  sbChat.appendChild(d);
  sbChat.scrollTop = sbChat.scrollHeight;

  const log = JSON.parse(localStorage.getItem("SB_CHAT")||"[]");
  log.push({who,text,ts:Date.now(),mode:sbMode});
  localStorage.setItem("SB_CHAT", JSON.stringify(log));
}

function sbSetMode(m){
  sbMode = m;
  sbAdd("Mode: " + m.toUpperCase(), "bot");
  setStatus("Mode: " + m);
}

qsa('#page-studybuddy [data-mode]').forEach(b=>{
  b.addEventListener("click", ()=>sbSetMode(b.dataset.mode));
});

function sbMath(q){
  try{
    if(!/^[0-9+\-*/(). %]+$/.test(q)){
      sbAdd("Enter valid math only.", "bot"); return;
    }
    const ans = Function("return ("+q+")")();
    sbAdd("Answer: " + ans, "bot");
  }catch{
    sbAdd("Math error.", "bot");
  }
}

function sbQuiz(){
  const q = [
    "üß† Capital of Pakistan?",
    "üß† 5 daily prayers names?",
    "üß† 12 √ó 7 = ?",
    "üß† What is the largest planet?",
    "üß† What is H2O?"
  ];
  sbAdd(q[Math.floor(Math.random()*q.length)], "bot");
}

function sbIslam(){
  const i = [
    "üïå Allah is One (Tawheed).",
    "üìñ Quran is guidance for mankind.",
    "ü§≤ Dua: Allahumma zidni ilma.",
    "üïã Pray 5 times daily.",
    "üåô Say: SubhanAllah ‚Ä¢ Alhamdulillah ‚Ä¢ Allahu Akbar"
  ];
  sbAdd(i[Math.floor(Math.random()*i.length)], "bot");
}

function sbChatAI(t){
  const q = t.toLowerCase();
  if(q.includes("hi") || q.includes("hello")) sbAdd("Hello üòä", "bot");
  else if(q.includes("who made you")) sbAdd("Made by Yousaf üåü", "bot");
  else if(q.includes("help")) sbAdd("I can do: Chat, Math, Quiz, Islam, Games, Minecraft, Chatterly, SuperGPT.", "bot");
  else sbAdd("Tell me more ü§î", "bot");
}

function sbSend(){
  const t = sbInput.value.trim();
  if(!t) return;
  sbInput.value = "";
  sbAdd(t, "user");

  if(sbMode==="math") sbMath(t);
  else if(sbMode==="quiz") sbQuiz();
  else if(sbMode==="islam") sbIslam();
  else sbChatAI(t);
}

$("sbSendBtn").addEventListener("click", sbSend);
sbInput.addEventListener("keydown", (e)=>{ if(e.key==="Enter") sbSend(); });

(function loadSB(){
  const log = JSON.parse(localStorage.getItem("SB_CHAT")||"[]");
  sbChat.innerHTML = "";
  if(!log.length){
    sbAdd("Welcome to StudyBuddy AI üöÄ", "bot");
    sbAdd("Choose a page from left menu.", "bot");
    return;
  }
  log.forEach(m=>sbAdd(m.text, m.who));
})();

/* =========================
   GAMES HUB
========================= */
const games = [
  "Tic Tac Toe","Snake","Memory Flip","Number Guess","Rock Paper Scissors",
  "Math Quiz","Word Guess","Fast Click","Reaction Test","Typing Speed",
  "Color Match","Pattern Memory","Maze","Puzzle","2048 Style",
  "Simon Says","Hangman","Quiz Master","Brain Trainer","Sudoku Mini",
  "Chess Mini","Checkers","Math Duel","Logic Test","True False",
  "Speed Math","Guess Shape","Hidden Object","Tap Challenge","Emoji Match",
  "Word Scramble","Quick Tap","Aim Trainer","Random Riddle","Mini RPG"
];

function loadGames(){
  const list = $("gameList");
  list.innerHTML = "";
  games.forEach(name=>{
    const b = document.createElement("button");
    b.type = "button";
    b.className = "gameBtn";
    b.innerHTML = `<b>${escapeHTML(name)}</b><div class="small">Demo: engine can be added</div>`;
    b.addEventListener("click", ()=>alert(name + " is ready (demo)."));
    list.appendChild(b);
  });
}
loadGames();

$("reloadGames").addEventListener("click", loadGames);

$("gameSearch").addEventListener("input", ()=>{
  const q = $("gameSearch").value.toLowerCase();
  qsa("#gameList .gameBtn").forEach(btn=>{
    btn.style.display = btn.innerText.toLowerCase().includes(q) ? "block" : "none";
  });
});

/* =========================
   CHATTERLY OFFLINE
========================= */
let chUser = null;

function chLoad(){
  const u = JSON.parse(localStorage.getItem("CH_USER")||"null");
  chUser = u;
  if(chUser){
    $("chLoginCard").style.display="none";
    $("chChatCard").style.display="block";
    chRenderMessages();
    $("chMsg").textContent="";
  }else{
    $("chLoginCard").style.display="block";
    $("chChatCard").style.display="none";
  }
}

function chGetAccounts(){
  return JSON.parse(localStorage.getItem("CH_ACCOUNTS")||"{}");
}
function chSetAccounts(obj){
  localStorage.setItem("CH_ACCOUNTS", JSON.stringify(obj));
}

function chSignup(){
  const email = $("chEmail").value.trim().toLowerCase();
  const pass = $("chPass").value.trim();
  if(!email || !pass) { $("chMsg").textContent="Enter email and password."; return; }
  const acc = chGetAccounts();
  if(acc[email]) { $("chMsg").textContent="Account already exists."; return; }
  acc[email] = {pass};
  chSetAccounts(acc);
  $("chMsg").textContent="Account created. Now login.";
}

function chLogin(){
  const email = $("chEmail").value.trim().toLowerCase();
  const pass = $("chPass").value.trim();
  const acc = chGetAccounts();
  if(!acc[email] || acc[email].pass!==pass){
    $("chMsg").textContent="Wrong email or password.";
    return;
  }
  localStorage.setItem("CH_USER", JSON.stringify({email}));
  chLoad();
}

function chLogout(){
  localStorage.removeItem("CH_USER");
  chUser=null;
  chLoad();
}

function chGetMsgs(){
  return JSON.parse(localStorage.getItem("CH_MSGS")||"[]");
}
function chSetMsgs(m){
  localStorage.setItem("CH_MSGS", JSON.stringify(m));
}

function chSend(){
  if(!chUser) return;
  const t = $("chInput").value.trim();
  if(!t) return;
  $("chInput").value="";
  const msgs = chGetMsgs();
  msgs.push({email:chUser.email,text:t,ts:Date.now()});
  chSetMsgs(msgs);
  chRenderMessages();
}

function chRenderMessages(){
  const box = $("chMessages");
  const msgs = chGetMsgs();
  box.innerHTML="";
  msgs.slice(-200).forEach(m=>{
    const div = document.createElement("div");
    div.style.marginBottom="8px";
    div.style.padding="10px";
    div.style.borderRadius="12px";
    div.style.border="1px solid var(--line)";
    const me = chUser && m.email===chUser.email;
    div.style.background = me ? "rgba(37,99,235,0.22)" : "rgba(0,0,0,0.10)";
    div.innerHTML = `<b>${escapeHTML(m.email.split("@")[0])}</b><div>${escapeHTML(m.text)}</div>`;
    box.appendChild(div);
  });
  box.scrollTop = box.scrollHeight;
}

$("chSignup").addEventListener("click", chSignup);
$("chLogin").addEventListener("click", chLogin);
$("chLogout").addEventListener("click", chLogout);
$("chSend").addEventListener("click", chSend);
$("chInput").addEventListener("keydown", (e)=>{ if(e.key==="Enter") chSend(); });
chLoad();

/* =========================
   SUPER GPT CLONE
========================= */
const sgChat = $("sgChat");
const sgInput = $("sgInput");

function sgAdd(text, who){
  const d = document.createElement("div");
  d.className = "msg " + who;
  d.innerHTML = who==="bot" ? text : escapeHTML(text);
  sgChat.appendChild(d);
  sgChat.scrollTop = sgChat.scrollHeight;

  const log = JSON.parse(localStorage.getItem("SG_CHAT")||"[]");
  log.push({who,text,ts:Date.now()});
  localStorage.setItem("SG_CHAT", JSON.stringify(log));
}

function sgBot(text){
  const lower = text.toLowerCase();
  const now = new Date();
  if(lower.includes("hello") || lower.includes("hi")) return "Hello! I'm your offline ChatGPT clone.";
  if(lower.includes("who are you")) return "I am a local demo assistant (offline).";
  if(lower.includes("what can you do")) return "I can chat, show time/date, and give basic responses.";
  if(lower.includes("time")) return "Current time: <b>"+now.toLocaleTimeString()+"</b>";
  if(lower.includes("date")) return "Today's date: <b>"+now.toLocaleDateString()+"</b>";
  if(lower.includes("code")) return "<pre style='margin:0;white-space:pre-wrap'>console.log('Hello world');</pre>";
  if(lower.includes("markdown")) return "<b>Bold</b> <i>Italic</i> <code>inline</code>";
  return "Offline demo response. Add more rules in code to make me smarter.";
}

function sgSend(){
  const t = sgInput.value.trim();
  if(!t) return;
  sgInput.value="";
  sgAdd(t,"user");
  setTimeout(()=>sgAdd(sgBot(t),"bot"), 300);
}

$("sgSend").addEventListener("click", sgSend);
sgInput.addEventListener("keydown", (e)=>{ if(e.key==="Enter") sgSend(); });

$("sgNewChat").addEventListener("click", ()=>{
  localStorage.removeItem("SG_CHAT");
  sgChat.innerHTML="";
  sgAdd("New chat started. Ask me anything.", "bot");
});

$("sgDark").addEventListener("click", toggleTheme);

(function loadSG(){
  const log = JSON.parse(localStorage.getItem("SG_CHAT")||"[]");
  sgChat.innerHTML="";
  if(!log.length){
    sgAdd("New chat started. Ask me anything.", "bot");
    return;
  }
  log.forEach(m=>{
    if(m.who==="bot") sgAdd(m.text,"bot");
    else sgAdd(m.text,"user");
  });
})();

/* =========================
   MINECRAFT MINI
========================= */
const mc = {
  w: 19, h: 11, tile: 40,
  grid: [],
  player: {x:2,y:2,hp:100,max:100,alive:true,wood:0,stone:0},
  boss: null,
  bossKills: 0
};

const cv = $("mcCanvas");
const ctx = cv.getContext("2d");

function mcNewWorld(){
  mc.grid = [];
  for(let y=0;y<mc.h;y++){
    const row=[];
    for(let x=0;x<mc.w;x++){
      let v="grass";
      if(y>6) v="stone";
      if(y===6) v="dirt";
      if(Math.random()<0.08 && y<6) v="tree";
      if(Math.random()<0.03 && y>6) v="ore";
      row.push(v);
    }
    mc.grid.push(row);
  }
  mc.player.x=2; mc.player.y=2;
  mc.player.hp=mc.player.max;
  mc.player.alive=true;
  mc.player.wood=0; mc.player.stone=0;
  mc.boss=null;
  mcDraw();
  mcUpdateStats();
  $("mcOut").textContent="New world created.";
}

function mcColor(t){
  if(t==="grass") return "#2ecc71";
  if(t==="dirt") return "#8b5a2b";
  if(t==="stone") return "#9ca3af";
  if(t==="tree") return "#166534";
  if(t==="ore") return "#fbbf24";
  if(t==="air") return "rgba(0,0,0,0)";
  return "#111827";
}

function mcDraw(){
  ctx.clearRect(0,0,cv.width,cv.height);
  const tw = Math.floor(cv.width / mc.tile);
  const th = Math.floor(cv.height / mc.tile);

  for(let y=0;y<mc.h;y++){
    for(let x=0;x<mc.w;x++){
      const t = mc.grid[y][x];
      ctx.fillStyle = mcColor(t);
      ctx.fillRect(x*mc.tile, y*mc.tile, mc.tile-1, mc.tile-1);
    }
  }

  // boss
  if(mc.boss && mc.boss.alive){
    ctx.fillStyle="#ef4444";
    ctx.fillRect(mc.boss.x*mc.tile+6, mc.boss.y*mc.tile+6, mc.tile-12, mc.tile-12);
  }

  // player
  ctx.fillStyle = mc.player.alive ? "#60a5fa" : "#6b7280";
  ctx.fillRect(mc.player.x*mc.tile+8, mc.player.y*mc.tile+8, mc.tile-16, mc.tile-16);

  // ui
  ctx.fillStyle="rgba(0,0,0,0.35)";
  ctx.fillRect(10,10,240,40);
  ctx.fillStyle="#fff";
  ctx.font="14px Arial";
  ctx.fillText("HP: "+mc.player.hp+"/"+mc.player.max+" | Boss Kills: "+mc.bossKills, 18, 36);
}

function mcUpdateStats(){
  $("mcStats").innerHTML =
    "HP: <b>"+mc.player.hp+"</b> / "+mc.player.max+
    "<br>Wood: <b>"+mc.player.wood+"</b>"+
    "<br>Stone: <b>"+mc.player.stone+"</b>"+
    "<br>Alive: <b>"+(mc.player.alive?"Yes":"No")+"</b>";
}

function mcMove(dx,dy){
  if(!mc.player.alive) return;
  const nx = mc.player.x+dx;
  const ny = mc.player.y+dy;
  if(nx<0||ny<0||nx>=mc.w||ny>=mc.h) return;

  // can't walk into stone deep
  const t = mc.grid[ny][nx];
  if(t==="stone") return;

  mc.player.x=nx;
  mc.player.y=ny;

  // boss damage if close
  if(mc.boss && mc.boss.alive){
    const dist = Math.abs(mc.boss.x-mc.player.x)+Math.abs(mc.boss.y-mc.player.y);
    if(dist<=1){
      mc.player.hp -= mc.boss.dmg;
      if(mc.player.hp<=0){
        mc.player.hp=0;
        mc.player.alive=false;
        $("mcOut").textContent="You died. Use /revive";
      }
    }
  }

  mcDraw();
  mcUpdateStats();
}

document.addEventListener("keydown",(e)=>{
  if(!$("page-minecraft").classList.contains("active")) return;

  if(e.key==="ArrowUp" || e.key==="w") mcMove(0,-1);
  if(e.key==="ArrowDown" || e.key==="s") mcMove(0,1);
  if(e.key==="ArrowLeft" || e.key==="a") mcMove(-1,0);
  if(e.key==="ArrowRight" || e.key==="d") mcMove(1,0);
});

cv.addEventListener("click",(e)=>{
  if(!$("page-minecraft").classList.contains("active")) return;
  const rect = cv.getBoundingClientRect();
  const x = Math.floor((e.clientX-rect.left) / (rect.width / cv.width) / mc.tile);
  const y = Math.floor((e.clientY-rect.top) / (rect.height / cv.height) / mc.tile);
  if(x<0||y<0||x>=mc.w||y>=mc.h) return;

  const t = mc.grid[y][x];
  if(t==="tree"){
    mc.grid[y][x]="air";
    mc.player.wood++;
    $("mcOut").textContent="Mined wood +1";
  }else if(t==="dirt"){
    mc.grid[y][x]="air";
    mc.player.stone+=0;
    $("mcOut").textContent="Mined dirt.";
  }else if(t==="ore"){
    mc.grid[y][x]="air";
    mc.player.stone+=3;
    $("mcOut").textContent="Mined ore +3 stone";
  }else if(t==="grass"){
    // build tree if have wood
    if(mc.player.wood>0){
      mc.player.wood--;
      mc.grid[y][x]="tree";
      $("mcOut").textContent="Built tree (-1 wood)";
    }else{
      $("mcOut").textContent="Need wood to build.";
    }
  }

  mcDraw();
  mcUpdateStats();
});

function mcSpawnBoss(){
  mc.boss = {
    x: Math.min(mc.w-2, mc.player.x+4),
    y: mc.player.y,
    hp: 60 + Math.floor(Math.random()*60),
    dmg: 8 + Math.floor(Math.random()*6),
    alive:true
  };
  mcUpdateBossUI();
  mcDraw();
  $("mcOut").textContent="Boss spawned!";
}

function mcUpdateBossUI(){
  if(!mc.boss || !mc.boss.alive){
    $("mcBoss").innerHTML = "Boss: <b>None</b>";
    return;
  }
  $("mcBoss").innerHTML =
    "Boss HP: <b>"+mc.boss.hp+"</b> ‚Ä¢ DMG: <b>"+mc.boss.dmg+"</b>";
}

function mcAttackBoss(){
  if(!mc.player.alive){ $("mcOut").textContent="You are dead."; return; }
  if(!mc.boss || !mc.boss.alive){ $("mcOut").textContent="No boss."; return; }

  const dist = Math.abs(mc.boss.x-mc.player.x)+Math.abs(mc.boss.y-mc.player.y);
  if(dist>2){ $("mcOut").textContent="Go closer to boss."; return; }

  const dmg = 10 + Math.floor(Math.random()*12) + Math.floor(mc.player.stone/2);
  mc.boss.hp -= dmg;

  if(mc.boss.hp<=0){
    mc.boss.hp=0;
    mc.boss.alive=false;
    mc.bossKills++;
    mc.player.stone += 5;
    mc.player.wood += 2;
    $("mcOut").textContent="Boss defeated! Respawn infinite.";
  }else{
    $("mcOut").textContent="You hit boss for "+dmg;
  }

  mcUpdateBossUI();
  mcDraw();
  mcUpdateStats();
}

function mcRunCommand(){
  const raw = $("mcCmd").value.trim();
  if(!raw) return;
  $("mcCmd").value="";

  const cmd = raw.toLowerCase();

  if(cmd==="/kill"){
    mc.player.hp=0;
    mc.player.alive=false;
    $("mcOut").textContent="Killed player. Use /revive";
  }
  else if(cmd==="/revive"){
    mc.player.alive=true;
    mc.player.hp=mc.player.max;
    $("mcOut").textContent="Player revived.";
  }
  else if(cmd==="/destroyworld"){
    // destroy all blocks except keep player tile
    for(let y=0;y<mc.h;y++){
      for(let x=0;x<mc.w;x++){
        if(x===mc.player.x && y===mc.player.y) continue;
        mc.grid[y][x]="air";
      }
    }
    $("mcOut").textContent="World destroyed (except player).";
  }
  else{
    $("mcOut").textContent="Unknown command.";
  }

  mcDraw();
  mcUpdateStats();
  mcUpdateBossUI();
}

$("mcNewWorld").addEventListener("click", mcNewWorld);
$("mcSpawnBoss").addEventListener("click", mcSpawnBoss);
$("mcAttackBoss").addEventListener("click", mcAttackBoss);
$("mcRunCmd").addEventListener("click", mcRunCommand);
$("mcCmd").addEventListener("keydown",(e)=>{ if(e.key==="Enter") mcRunCommand(); });
$("mcHeal").addEventListener("click", ()=>{
  if(!mc.player.alive){ $("mcOut").textContent="Dead. Use /revive"; return; }
  mc.player.hp = Math.min(mc.player.max, mc.player.hp+35);
  $("mcOut").textContent="Healed +35";
  mcDraw(); mcUpdateStats();
});

mcNewWorld();
mcUpdateBossUI();

/* =========================
   INIT
========================= */
showPage("studybuddy");
</script>
</body>
</html>
